- name: Terraform Apply
  working-directory: terraform
  run: terraform apply -auto-approve
  env:
    TF_VAR_public_key: ${{ secrets.EC2_PUBLIC_KEY }}

- name: Get EC2 Public IP
  working-directory: terraform
  run: echo "EC2_IP=$(terraform output -raw ec2_public_ip)" >> $GITHUB_ENV

- name: Setup SSH Key
  run: |
    mkdir -p ~/.ssh
    echo "${{ secrets.EC2_PRIVATE_KEY }}" > ~/.ssh/key.pem
    chmod 600 ~/.ssh/key.pem

- name: Deploy Docker Containers on EC2
  run: |
    ssh -o StrictHostKeyChecking=no -i ~/.ssh/key.pem ec2-user@$EC2_IP << EOF
      sudo yum update -y
      sudo amazon-linux-extras install docker -y
      sudo service docker start
      sudo usermod -aG docker ec2-user

      sudo curl -L https://github.com/docker/compose/releases/download/v2.27.0/docker-compose-linux-x86_64 \
        -o /usr/local/bin/docker-compose
      sudo chmod +x /usr/local/bin/docker-compose

      docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}

      if [ ! -d "devops-assignment" ]; then
        git clone https://github.com/${{ github.repository }}.git
      fi

      cd devops-assignment
      docker pull ${{ secrets.DOCKER_USERNAME }}/devops-api:latest
      docker compose down || true
      docker compose up -d
    EOF
